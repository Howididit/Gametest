<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tap to Split - Payment Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .container {
            text-align: center;
            max-width: 600px;
            width: 90%;
            padding: 20px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 30px;
        }

        .setup-screen, .waiting-screen, .game-screen, .result-screen {
            display: none;
        }

        .setup-screen.active, .waiting-screen.active, .game-screen.active, .result-screen.active {
            display: block;
        }

        .input-group {
            margin: 20px 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        input {
            padding: 12px;
            font-size: 1.1rem;
            border: none;
            border-radius: 8px;
            width: 100%;
            max-width: 300px;
            text-align: center;
        }

        button {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        button:hover {
            background: #ff5252;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .game-info {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .info-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 5px;
        }

        .tap-area {
            background: rgba(255,255,255,0.2);
            border: 3px dashed rgba(255,255,255,0.5);
            border-radius: 20px;
            padding: 60px 20px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.1s ease;
            user-select: none;
        }

        .tap-area:active {
            transform: scale(0.95);
            background: rgba(255,255,255,0.3);
        }

        .tap-area.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .scores {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }

        .player-score {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            flex: 1;
            margin: 0 10px;
        }

        .player-name {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .score {
            font-size: 2rem;
            font-weight: bold;
        }

        .timer {
            font-size: 3rem;
            font-weight: bold;
            margin: 20px 0;
            color: #ffeb3b;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .result {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .payment-split {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }

        .payment-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            flex: 1;
            margin: 0 10px;
        }

        .status {
            margin: 15px 0;
            font-size: 1.1rem;
        }

        .error {
            color: #ff6b6b;
            background: rgba(255,107,107,0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ’° Tap to Split</h1>
        <p class="subtitle">The faster you tap, the less you pay!</p>

        <!-- Setup Screen -->
        <div class="setup-screen active">
            <div class="input-group">
                <label for="billAmount">Bill Amount ($)</label>
                <input type="number" id="billAmount" value="100" min="1" step="0.01" placeholder="Enter bill amount">
            </div>
            <div class="input-group">
                <label for="playerName">Your Name</label>
                <input type="text" id="playerName" placeholder="Enter your name" maxlength="20">
            </div>
            <div class="input-group">
                <label for="gameId">Game ID (share with friend)</label>
                <input type="text" id="gameId" placeholder="Enter or create game ID" maxlength="20">
            </div>
            <button onclick="joinGame()">Join Game</button>
            <button onclick="generateGameId()">Generate Random ID</button>
            <div id="setupError" class="error" style="display: none;"></div>
        </div>

        <!-- Waiting Screen -->
        <div class="waiting-screen">
            <h2>Waiting for opponent...</h2>
            <p class="status">Game ID: <strong id="currentGameId"></strong></p>
            <p>Share this ID with your friend!</p>
            <div id="waitingStatus"></div>
            <button onclick="leaveGame()">Leave Game</button>
        </div>

        <!-- Game Screen -->
        <div class="game-screen">
            <div class="game-info">
                <div class="info-item">
                    <div class="info-label">Bill Amount</div>
                    <div class="info-value" id="gameAmount">$100</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Time Left</div>
                    <div class="info-value timer" id="timer">10</div>
                </div>
            </div>

            <div class="scores">
                <div class="player-score">
                    <div class="player-name" id="player1Name">Player 1</div>
                    <div class="score" id="player1Score">0</div>
                </div>
                <div class="player-score">
                    <div class="player-name" id="player2Name">Player 2</div>
                    <div class="score" id="player2Score">0</div>
                </div>
            </div>

            <div class="tap-area" id="tapArea" onclick="handleTap()">
                <h2>TAP HERE!</h2>
                <p>Tap as fast as you can!</p>
            </div>

            <div id="gameStatus" class="status"></div>
        </div>

        <!-- Result Screen -->
        <div class="result-screen">
            <h2>ðŸŽ‰ Game Over!</h2>
            <div class="result">
                <div class="scores">
                    <div class="player-score">
                        <div class="player-name" id="finalPlayer1Name">Player 1</div>
                        <div class="score" id="finalPlayer1Score">0</div>
                    </div>
                    <div class="player-score">
                        <div class="player-name" id="finalPlayer2Name">Player 2</div>
                        <div class="score" id="finalPlayer2Score">0</div>
                    </div>
                </div>
                
                <div class="payment-split">
                    <div class="payment-item">
                        <div class="player-name" id="paymentPlayer1Name">Player 1</div>
                        <div class="info-value" id="paymentPlayer1Amount">$0</div>
                    </div>
                    <div class="payment-item">
                        <div class="player-name" id="paymentPlayer2Name">Player 2</div>
                        <div class="info-value" id="paymentPlayer2Amount">$0</div>
                    </div>
                </div>
            </div>
            <button onclick="startNewGame()">Play Again</button>
        </div>
    </div>

    <script type="module">
        // Simple WebSocket-like implementation using a mock server
        // In a real deployment, you'd use Firebase Realtime Database or WebSockets
        
        let gameState = {
            gameId: null,
            playerName: null,
            billAmount: 100,
            players: {},
            scores: {},
            gameStatus: 'waiting', // waiting, playing, finished
            timeLeft: 10,
            gameTimer: null
        };

        // Mock real-time database (replace with Firebase in production)
        let mockDatabase = {};
        let subscribers = {};

        function subscribe(path, callback) {
            if (!subscribers[path]) subscribers[path] = [];
            subscribers[path].push(callback);
        }

        function update(path, data) {
            mockDatabase[path] = { ...mockDatabase[path], ...data };
            if (subscribers[path]) {
                subscribers[path].forEach(callback => callback(mockDatabase[path]));
            }
        }

        function get(path) {
            return mockDatabase[path] || {};
        }

        // Game functions
        window.generateGameId = function() {
            const id = Math.random().toString(36).substring(2, 8).toUpperCase();
            document.getElementById('gameId').value = id;
        };

        window.joinGame = function() {
            const billAmount = parseFloat(document.getElementById('billAmount').value);
            const playerName = document.getElementById('playerName').value.trim();
            const gameId = document.getElementById('gameId').value.trim().toUpperCase();

            if (!billAmount || billAmount <= 0) {
                showError('Please enter a valid bill amount');
                return;
            }
            if (!playerName) {
                showError('Please enter your name');
                return;
            }
            if (!gameId) {
                showError('Please enter a game ID');
                return;
            }

            gameState.billAmount = billAmount;
            gameState.playerName = playerName;
            gameState.gameId = gameId;

            // Join the game
            const currentGame = get(`games/${gameId}`) || {};
            const players = currentGame.players || {};
            
            if (Object.keys(players).length >= 2 && !players[playerName]) {
                showError('Game is full');
                return;
            }

            players[playerName] = {
                name: playerName,
                score: 0,
                joined: Date.now()
            };

            update(`games/${gameId}`, {
                billAmount: billAmount,
                players: players,
                gameStatus: Object.keys(players).length === 2 ? 'ready' : 'waiting'
            });

            showScreen('waiting-screen');
            document.getElementById('currentGameId').textContent = gameId;

            // Subscribe to game updates
            subscribe(`games/${gameId}`, handleGameUpdate);
        };

        function handleGameUpdate(gameData) {
            if (!gameData) return;

            const players = Object.values(gameData.players || {});
            
            if (gameData.gameStatus === 'waiting' || gameData.gameStatus === 'ready') {
                updateWaitingScreen(players);
                if (gameData.gameStatus === 'ready' && players.length === 2) {
                    setTimeout(startGame, 2000);
                }
            } else if (gameData.gameStatus === 'playing') {
                updateGameScreen(gameData);
            } else if (gameData.gameStatus === 'finished') {
                showResults(gameData);
            }
        }

        function updateWaitingScreen(players) {
            const status = document.getElementById('waitingStatus');
            if (players.length === 1) {
                status.innerHTML = `<p>1 player joined. Waiting for opponent...</p>`;
            } else if (players.length === 2) {
                status.innerHTML = `<p>âœ… Both players joined! Starting game in 2 seconds...</p>`;
            }
        }

        function startGame() {
            const gameData = get(`games/${gameState.gameId}`);
            const players = Object.values(gameData.players);
            
            // Reset scores
            players.forEach(player => {
                gameData.players[player.name].score = 0;
            });

            update(`games/${gameState.gameId}`, {
                ...gameData,
                gameStatus: 'playing',
                timeLeft: 10,
                startTime: Date.now()
            });

            showScreen('game-screen');
            updateGameInfo(gameData);
            startTimer();
        }

        function updateGameInfo(gameData) {
            document.getElementById('gameAmount').textContent = `$${gameData.billAmount}`;
            const players = Object.values(gameData.players);
            
            if (players.length >= 2) {
                document.getElementById('player1Name').textContent = players[0].name;
                document.getElementById('player2Name').textContent = players[1].name;
                document.getElementById('player1Score').textContent = players[0].score || 0;
                document.getElementById('player2Score').textContent = players[1].score || 0;
            }
        }

        function updateGameScreen(gameData) {
            updateGameInfo(gameData);
            document.getElementById('timer').textContent = gameData.timeLeft || 0;
        }

        function startTimer() {
            let timeLeft = 10;
            document.getElementById('timer').textContent = timeLeft;
            
            gameState.gameTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;
                
                update(`games/${gameState.gameId}`, {
                    ...get(`games/${gameState.gameId}`),
                    timeLeft: timeLeft
                });

                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        window.handleTap = function() {
            const gameData = get(`games/${gameState.gameId}`);
            if (gameData.gameStatus !== 'playing') return;

            // Increment player's score
            const players = gameData.players;
            if (players[gameState.playerName]) {
                players[gameState.playerName].score = (players[gameState.playerName].score || 0) + 1;
                
                update(`games/${gameState.gameId}`, {
                    ...gameData,
                    players: players
                });
            }
        };

        function endGame() {
            if (gameState.gameTimer) {
                clearInterval(gameState.gameTimer);
                gameState.gameTimer = null;
            }

            const gameData = get(`games/${gameState.gameId}`);
            update(`games/${gameState.gameId}`, {
                ...gameData,
                gameStatus: 'finished'
            });
        }

        function showResults(gameData) {
            showScreen('result-screen');
            
            const players = Object.values(gameData.players);
            const totalTaps = players.reduce((sum, player) => sum + (player.score || 0), 0);
            
            if (players.length >= 2) {
                // Update final scores
                document.getElementById('finalPlayer1Name').textContent = players[0].name;
                document.getElementById('finalPlayer2Name').textContent = players[1].name;
                document.getElementById('finalPlayer1Score').textContent = players[0].score || 0;
                document.getElementById('finalPlayer2Score').textContent = players[1].score || 0;
                
                // Calculate payment split
                let player1Payment, player2Payment;
                
                if (totalTaps === 0) {
                    // If no one tapped, split evenly
                    player1Payment = player2Payment = gameData.billAmount / 2;
                } else {
                    // The person who tapped more pays less
                    const player1Ratio = (players[0].score || 0) / totalTaps;
                    const player2Ratio = (players[1].score || 0) / totalTaps;
                    
                    // Inverse the ratio - more taps = less payment
                    player1Payment = gameData.billAmount * (1 - player1Ratio);
                    player2Payment = gameData.billAmount * (1 - player2Ratio);
                }
                
                document.getElementById('paymentPlayer1Name').textContent = players[0].name;
                document.getElementById('paymentPlayer2Name').textContent = players[1].name;
                document.getElementById('paymentPlayer1Amount').textContent = `$${player1Payment.toFixed(2)}`;
                document.getElementById('paymentPlayer2Amount').textContent = `$${player2Payment.toFixed(2)}`;
            }
        }

        window.startNewGame = function() {
            // Reset game state
            gameState = {
                gameId: null,
                playerName: null,
                billAmount: 100,
                players: {},
                scores: {},
                gameStatus: 'waiting',
                timeLeft: 10,
                gameTimer: null
            };
            
            showScreen('setup-screen');
            
            // Clear form
            document.getElementById('gameId').value = '';
            document.getElementById('playerName').value = '';
        };

        window.leaveGame = function() {
            startNewGame();
        };

        function showScreen(screenClass) {
            document.querySelectorAll('.setup-screen, .waiting-screen, .game-screen, .result-screen')
                .forEach(screen => screen.classList.remove('active'));
            document.querySelector(`.${screenClass}`).classList.add('active');
        }

        function showError(message) {
            const errorEl = document.getElementById('setupError');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }

        // Initialize
        generateGameId();
    </script>
</body>
</html>